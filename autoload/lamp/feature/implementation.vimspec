let s:expect = themis#helper('expect')

Describe lamp#feature#implementation

  Before each
    let s:server = lamp#register('typescript-language-server', {
          \   'command': [lamp#config('global.root') . '/node_modules/.bin/typescript-language-server', '--stdio'],
          \   'filetypes': ['typescript', 'typescript.tsx'],
          \   'root_uri': { -> lamp#config('global.root') . '/misc/typescript/' }
          \ })
    call lamp#sync(s:server.start())
    call lamp#sync(s:server.initialize())
  End

  After each
    call lamp#sync(s:server.stop())
    call lamp#view#buffer#reset()
  End

  It Should retrieve one implementations
    call lamp#view#buffer#open('vsplit', {
          \   'filename': lamp#config('global.root') . '/misc/typescript/src/index.ts',
          \   'lnum': 1,
          \   'col': 10
          \ })
    set filetype=typescript

    let l:bufnr = bufnr('%')
    call lamp#feature#implementation#do('edit')
    call lamp#sync({ -> l:bufnr != bufnr('%') })
  End

  It Should retrieve multiple implementations
    call lamp#view#buffer#open('vsplit', {
          \   'filename': lamp#config('global.root') . '/misc/typescript/src/index.ts',
          \   'lnum': 3,
          \   'col': 37
          \ })
    set filetype=typescript

    let l:buftype = getbufvar('%', '&buftype')
    call lamp#feature#implementation#do('edit')
    call lamp#sync({ -> l:buftype != getbufvar('%', '&buftype') })
    call s:expect(getbufvar(bufnr('%'), '&buftype')).to_equal('quickfix')
  End

  It Should retrieve multiple implementations for custom handler
    call lamp#view#buffer#open('vsplit', {
          \   'filename': lamp#config('global.root') . '/misc/typescript/src/index.ts',
          \   'lnum': 3,
          \   'col': 37
          \ })
    set filetype=typescript

    let s:called = v:false
    call lamp#config('view.location.on_location', { -> execute('let s:called = v:true') })
    call lamp#feature#implementation#do('edit')
    call lamp#sync({ -> s:called })
    call lamp#config('view.location.on_location', { locations -> [setqflist(locations), execute('copen')] })
  End

End

